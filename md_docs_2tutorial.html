<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>POSIX Shared Memory Data Structures: Tutorial: Building High-Performance IPC Systems</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">POSIX Shared Memory Data Structures<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">High-performance lock-free data structures for inter-process communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2tutorial.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tutorial: Building High-Performance IPC Systems</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md72"></a> </p>
<h1><a class="anchor" id="autotoc_md73"></a>
Table of Contents</h1>
<ol type="1">
<li>Basic Concepts</li>
<li>Simple Producer-Consumer</li>
<li>Particle Simulation System</li>
<li>Sensor Data Pipeline</li>
<li>Multi-Process Coordination</li>
<li>Error Handling &amp; Recovery</li>
</ol>
<h1><a class="anchor" id="autotoc_md74"></a>
Basic Concepts</h1>
<h2><a class="anchor" id="autotoc_md75"></a>
The Power of the Table System</h2>
<p>The metadata table is what makes our shared memory system powerful. It allows <b>multiple data structures to coexist in the same shared memory segment</b>, each discoverable by name. This is crucial for complex systems.</p>
<div class="fragment"><div class="line"><span class="comment">// One shared memory segment, many data structures!</span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;my_system&quot;</span>, 100 * 1024 * 1024);  <span class="comment">// 100MB total</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// All these live in the SAME shared memory:</span></div>
<div class="line"><a class="code hl_class" href="classshm__array.html">shm_array&lt;float&gt;</a> sensor_data(shm, <span class="stringliteral">&quot;sensors&quot;</span>, 10000);</div>
<div class="line"><a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Event&gt;</a> event_queue(shm, <span class="stringliteral">&quot;events&quot;</span>, 500);</div>
<div class="line"><a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> frame_counter(shm, <span class="stringliteral">&quot;frame&quot;</span>, 0);</div>
<div class="line"><a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Entity&gt;</a> entities(shm, <span class="stringliteral">&quot;entities&quot;</span>, 1000);</div>
<div class="line"><a class="code hl_class" href="classshm__ring__buffer.html">shm_ring_buffer&lt;LogEntry&gt;</a> logs(shm, <span class="stringliteral">&quot;logs&quot;</span>, 10000);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Another process can discover ALL of them:</span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm2(<span class="stringliteral">&quot;my_system&quot;</span>);  <span class="comment">// Open existing</span></div>
<div class="line"><a class="code hl_class" href="classshm__array.html">shm_array&lt;float&gt;</a> sensors2(shm2, <span class="stringliteral">&quot;sensors&quot;</span>);  <span class="comment">// Find by name</span></div>
<div class="line"><a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Event&gt;</a> events2(shm2, <span class="stringliteral">&quot;events&quot;</span>);    <span class="comment">// Find by name</span></div>
<div class="line"><span class="comment">// ... etc</span></div>
<div class="ttc" id="aclassposix__shm__impl_html"><div class="ttname"><a href="classposix__shm__impl.html">posix_shm_impl&lt; shm_table &gt;</a></div></div>
<div class="ttc" id="aclassshm__array_html"><div class="ttname"><a href="classshm__array.html">shm_array</a></div><div class="ttdoc">Fixed-size array in shared memory with zero-overhead access.</div><div class="ttdef"><b>Definition</b> <a href="shm__array_8h_source.html#l00062">shm_array.h:63</a></div></div>
<div class="ttc" id="aclassshm__atomic_html"><div class="ttname"><a href="classshm__atomic.html">shm_atomic</a></div><div class="ttdoc">Shared memory atomic value with auto-discovery.</div><div class="ttdef"><b>Definition</b> <a href="shm__atomic_8h_source.html#l00019">shm_atomic.h:19</a></div></div>
<div class="ttc" id="aclassshm__object__pool_html"><div class="ttname"><a href="classshm__object__pool.html">shm_object_pool</a></div><div class="ttdoc">High-performance object pool for shared memory.</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00023">shm_object_pool.h:23</a></div></div>
<div class="ttc" id="aclassshm__queue_html"><div class="ttname"><a href="classshm__queue.html">shm_queue</a></div><div class="ttdoc">Lock-free circular queue for shared memory IPC.</div><div class="ttdef"><b>Definition</b> <a href="shm__queue_8h_source.html#l00024">shm_queue.h:24</a></div></div>
<div class="ttc" id="aclassshm__ring__buffer_html"><div class="ttname"><a href="classshm__ring__buffer.html">shm_ring_buffer</a></div><div class="ttdoc">Lock-free ring buffer for high-throughput streaming data.</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00024">shm_ring_buffer.h:24</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md76"></a>
Creating Shared Memory</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="posix__shm_8h.html">posix_shm.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Process 1: Create shared memory</span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;my_simulation&quot;</span>, 10 * 1024 * 1024);  <span class="comment">// 10MB</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Process 2: Open existing shared memory</span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;my_simulation&quot;</span>);  <span class="comment">// Size discovered automatically</span></div>
<div class="ttc" id="aposix__shm_8h_html"><div class="ttname"><a href="posix__shm_8h.html">posix_shm.h</a></div><div class="ttdoc">Core POSIX shared memory management with automatic reference counting.</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md77"></a>
Choosing Table Configuration</h2>
<div class="fragment"><div class="line"><span class="comment">// Minimal overhead (904B) for embedded systems</span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm_small</a> shm(<span class="stringliteral">&quot;embedded&quot;</span>, 1024 * 1024);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Default (4KB) for most applications  </span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;default&quot;</span>, 10 * 1024 * 1024);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Large (26KB) for complex simulations</span></div>
<div class="line"><a class="code hl_class" href="classposix__shm__impl.html">posix_shm_large</a> shm(<span class="stringliteral">&quot;complex&quot;</span>, 100 * 1024 * 1024);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Custom configuration</span></div>
<div class="line"><span class="keyword">using </span>my_table = <a class="code hl_class" href="classshm__table__impl.html">shm_table_impl&lt;48, 128&gt;</a>;  <span class="comment">// 48 char names, 128 entries</span></div>
<div class="line"><span class="keyword">using </span>my_shm = <a class="code hl_class" href="classposix__shm__impl.html">posix_shm_impl&lt;my_table&gt;</a>;</div>
<div class="line">my_shm shm(<span class="stringliteral">&quot;custom&quot;</span>, 50 * 1024 * 1024);</div>
<div class="ttc" id="aclassshm__table__impl_html"><div class="ttname"><a href="classshm__table__impl.html">shm_table_impl</a></div><div class="ttdoc">Metadata table for managing shared memory data structures.</div><div class="ttdef"><b>Definition</b> <a href="shm__table_8h_source.html#l00020">shm_table.h:21</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md78"></a>
Complete Multi-Structure Example</h1>
<h2><a class="anchor" id="autotoc_md79"></a>
Game Server State (Multiple Structures in One Segment)</h2>
<p>This example shows how a game server uses multiple data structures in a single shared memory segment for different purposes:</p>
<div class="fragment"><div class="line"><span class="comment">// game_server.cpp</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="posix__shm_8h.html">posix_shm.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__array_8h.html">shm_array.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__queue_8h.html">shm_queue.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__object__pool_8h.html">shm_object_pool.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__atomic_8h.html">shm_atomic.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__ring__buffer_8h.html">shm_ring_buffer.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>GameServer {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// Single shared memory segment for everything</span></div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm_large</a> shm;  <span class="comment">// Using large table for many structures</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Game entities (dynamic allocation)</span></div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Player, shm_table_large&gt;</a> player_pool;</div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Monster, shm_table_large&gt;</a> monster_pool;</div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Projectile, shm_table_large&gt;</a> projectile_pool;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Spatial grid for collision detection</span></div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;uint32_t, shm_table_large&gt;</a> collision_grid;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Event queues for different systems</span></div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;DamageEvent, shm_table_large&gt;</a> damage_events;</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;SpawnRequest, shm_table_large&gt;</a> spawn_requests;</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;NetworkMessage, shm_table_large&gt;</a> network_msgs;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Performance metrics</span></div>
<div class="line">    <a class="code hl_class" href="classshm__ring__buffer.html">shm_ring_buffer&lt;FrameStats, shm_table_large&gt;</a> frame_history;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Global state</span></div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64&lt;shm_table_large&gt;</a> tick_counter;</div>
<div class="line">    shm_atomic_uint32&lt;shm_table_large&gt; player_count;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_bool&lt;shm_table_large&gt;</a> match_active;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Leaderboard</span></div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;ScoreEntry, shm_table_large&gt;</a> leaderboard;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    GameServer() </div>
<div class="line">        : shm(<span class="stringliteral">&quot;game_server&quot;</span>, 500 * 1024 * 1024),  <span class="comment">// 500MB total</span></div>
<div class="line">          <span class="comment">// Initialize all structures in the SAME shared memory</span></div>
<div class="line">          player_pool(shm, <span class="stringliteral">&quot;players&quot;</span>, 100),</div>
<div class="line">          monster_pool(shm, <span class="stringliteral">&quot;monsters&quot;</span>, 1000),  </div>
<div class="line">          projectile_pool(shm, <span class="stringliteral">&quot;projectiles&quot;</span>, 500),</div>
<div class="line">          collision_grid(shm, <span class="stringliteral">&quot;collision&quot;</span>, 256 * 256),</div>
<div class="line">          damage_events(shm, <span class="stringliteral">&quot;damage_queue&quot;</span>, 1000),</div>
<div class="line">          spawn_requests(shm, <span class="stringliteral">&quot;spawn_queue&quot;</span>, 100),</div>
<div class="line">          network_msgs(shm, <span class="stringliteral">&quot;network_queue&quot;</span>, 5000),</div>
<div class="line">          frame_history(shm, <span class="stringliteral">&quot;frame_stats&quot;</span>, 3600),  <span class="comment">// 1 minute at 60fps</span></div>
<div class="line">          tick_counter(shm, <span class="stringliteral">&quot;tick&quot;</span>, 0),</div>
<div class="line">          player_count(shm, <span class="stringliteral">&quot;players_online&quot;</span>, 0),</div>
<div class="line">          match_active(shm, <span class="stringliteral">&quot;match_active&quot;</span>, false),</div>
<div class="line">          leaderboard(shm, <span class="stringliteral">&quot;leaderboard&quot;</span>, 10) {</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Game server initialized with structures:\n&quot;</span>;</div>
<div class="line">        print_memory_layout();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> print_memory_layout() {</div>
<div class="line">        <span class="comment">// The table tracks everything!</span></div>
<div class="line">        <span class="keyword">auto</span>* table = shm.<a class="code hl_function" href="classposix__shm__impl.html#a5faab798a8baa37e8f522723339cc928">get_table</a>();</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Shared Memory Layout:\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Total size: 500MB\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Table overhead: &quot;</span> &lt;&lt; <span class="keyword">sizeof</span>(<a class="code hl_typedef" href="shm__table_8h.html#a4092ab716c07d6436f62dac011e22941">shm_table_large</a>) &lt;&lt; <span class="stringliteral">&quot; bytes\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Structures allocated: &quot;</span> &lt;&lt; table-&gt;get_entry_count() &lt;&lt; <span class="stringliteral">&quot;\n\n&quot;</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// We could iterate through all entries if the table exposed that</span></div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Named structures:\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - players (object pool): &quot;</span> &lt;&lt; player_pool.<a class="code hl_function" href="classshm__object__pool.html#ac4be6afd1ffe22c202ed3960b450eb6b">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; slots\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - monsters (object pool): &quot;</span> &lt;&lt; monster_pool.<a class="code hl_function" href="classshm__object__pool.html#ac4be6afd1ffe22c202ed3960b450eb6b">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; slots\n&quot;</span>; </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - projectiles (object pool): &quot;</span> &lt;&lt; projectile_pool.<a class="code hl_function" href="classshm__object__pool.html#ac4be6afd1ffe22c202ed3960b450eb6b">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; slots\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - collision (array): &quot;</span> &lt;&lt; collision_grid.<a class="code hl_function" href="classshm__array.html#afcfc180d427db16238d826d6292b5146">size</a>() &lt;&lt; <span class="stringliteral">&quot; cells\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - damage_queue: &quot;</span> &lt;&lt; damage_events.<a class="code hl_function" href="classshm__queue.html#ae572669e48b451812bd4fdae24cb0bd7">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; capacity\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - spawn_queue: &quot;</span> &lt;&lt; spawn_requests.<a class="code hl_function" href="classshm__queue.html#ae572669e48b451812bd4fdae24cb0bd7">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; capacity\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - network_queue: &quot;</span> &lt;&lt; network_msgs.<a class="code hl_function" href="classshm__queue.html#ae572669e48b451812bd4fdae24cb0bd7">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; capacity\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - frame_stats (ring): &quot;</span> &lt;&lt; frame_history.<a class="code hl_function" href="classshm__ring__buffer.html#a5212d32d511179bb618212695b02bb76">capacity</a>() &lt;&lt; <span class="stringliteral">&quot; samples\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - tick (atomic): current=&quot;</span> &lt;&lt; tick_counter.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - players_online (atomic): &quot;</span> &lt;&lt; player_count.load() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - match_active (atomic): &quot;</span> &lt;&lt; match_active.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  - leaderboard (array): &quot;</span> &lt;&lt; leaderboard.<a class="code hl_function" href="classshm__array.html#afcfc180d427db16238d826d6292b5146">size</a>() &lt;&lt; <span class="stringliteral">&quot; entries\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ai_system.cpp - Separate process that reads game state</span></div>
<div class="line"><span class="keyword">class </span>AISystem {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm_large</a> shm;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Discover existing structures by name</span></div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Player, shm_table_large&gt;</a> players;</div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Monster, shm_table_large&gt;</a> monsters;</div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;uint32_t, shm_table_large&gt;</a> collision_grid;</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;SpawnRequest, shm_table_large&gt;</a> spawn_queue;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64&lt;shm_table_large&gt;</a> tick;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    AISystem()</div>
<div class="line">        : shm(<span class="stringliteral">&quot;game_server&quot;</span>),  <span class="comment">// Attach to existing</span></div>
<div class="line">          <span class="comment">// Find all structures by name - they already exist!</span></div>
<div class="line">          players(shm, <span class="stringliteral">&quot;players&quot;</span>),</div>
<div class="line">          monsters(shm, <span class="stringliteral">&quot;monsters&quot;</span>),</div>
<div class="line">          collision_grid(shm, <span class="stringliteral">&quot;collision&quot;</span>),</div>
<div class="line">          spawn_queue(shm, <span class="stringliteral">&quot;spawn_queue&quot;</span>),</div>
<div class="line">          tick(shm, <span class="stringliteral">&quot;tick&quot;</span>) {</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;AI System connected to game server\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Found &quot;</span> &lt;&lt; monsters.<a class="code hl_function" href="classshm__object__pool.html#aea9935b1a397973c92cd05afde467e82">num_allocated</a>() &lt;&lt; <span class="stringliteral">&quot; active monsters\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> update_ai() {</div>
<div class="line">        uint64_t current_tick = tick.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Read monster positions, make decisions</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t handle = 0; handle &lt; monsters.<a class="code hl_function" href="classshm__object__pool.html#ac4be6afd1ffe22c202ed3960b450eb6b">capacity</a>(); ++handle) {</div>
<div class="line">            <span class="keywordflow">if</span> (<span class="keyword">auto</span>* monster = monsters.<a class="code hl_function" href="classshm__object__pool.html#a277a01ab36e5a3e34b75189d7cd19c7e">get</a>(handle)) {</div>
<div class="line">                <span class="comment">// Read collision grid around monster</span></div>
<div class="line">                <span class="keywordtype">int</span> grid_x = monster-&gt;x / CELL_SIZE;</div>
<div class="line">                <span class="keywordtype">int</span> grid_y = monster-&gt;y / CELL_SIZE;</div>
<div class="line">                uint32_t cell = collision_grid[grid_y * 256 + grid_x];</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// Make AI decision...</span></div>
<div class="line">                <span class="keywordflow">if</span> (should_spawn_adds(monster)) {</div>
<div class="line">                    SpawnRequest req{</div>
<div class="line">                        .type = SPAWN_MINION,</div>
<div class="line">                        .x = monster-&gt;x,</div>
<div class="line">                        .y = monster-&gt;y</div>
<div class="line">                    };</div>
<div class="line">                    spawn_queue.<a class="code hl_function" href="classshm__queue.html#ac67c4eeba55bf97de3ab7bf90a5422db">enqueue</a>(req);  <span class="comment">// Communicate back!</span></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// analytics.cpp - Another process for metrics</span></div>
<div class="line"><span class="keyword">class </span>Analytics {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm_large</a> shm;</div>
<div class="line">    <a class="code hl_class" href="classshm__ring__buffer.html">shm_ring_buffer&lt;FrameStats, shm_table_large&gt;</a> frame_history;</div>
<div class="line">    shm_atomic_uint32&lt;shm_table_large&gt; player_count;</div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;ScoreEntry, shm_table_large&gt;</a> leaderboard;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Analytics()</div>
<div class="line">        : shm(<span class="stringliteral">&quot;game_server&quot;</span>),</div>
<div class="line">          frame_history(shm, <span class="stringliteral">&quot;frame_stats&quot;</span>),</div>
<div class="line">          player_count(shm, <span class="stringliteral">&quot;players_online&quot;</span>),</div>
<div class="line">          leaderboard(shm, <span class="stringliteral">&quot;leaderboard&quot;</span>) {</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> generate_report() {</div>
<div class="line">        <span class="comment">// Read last 60 seconds of frame data</span></div>
<div class="line">        FrameStats stats[3600];</div>
<div class="line">        <span class="keywordtype">size_t</span> count = frame_history.<a class="code hl_function" href="classshm__ring__buffer.html#a9cd4ea497d7ad36296aad7a448007f03">get_last_n</a>(3600, stats);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Calculate metrics</span></div>
<div class="line">        <span class="keywordtype">double</span> avg_fps = calculate_average_fps(stats, count);</div>
<div class="line">        uint32_t current_players = player_count.load();</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;=== Performance Report ===\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Average FPS: &quot;</span> &lt;&lt; avg_fps &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Players online: &quot;</span> &lt;&lt; current_players &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;\nTop Players:\n&quot;</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; leaderboard.<a class="code hl_function" href="classshm__array.html#afcfc180d427db16238d826d6292b5146">size</a>(); ++i) {</div>
<div class="line">            <span class="keyword">auto</span>&amp; entry = leaderboard[i];</div>
<div class="line">            <span class="keywordflow">if</span> (entry.score &gt; 0) {</div>
<div class="line">                std::cout &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">&quot;. &quot;</span> &lt;&lt; entry.<a class="code hl_function" href="classshm__array.html#a21c2c90de45aec3d3e5686710a82c038">name</a> </div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot; - &quot;</span> &lt;&lt; entry.score &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassposix__shm__impl_html_a5faab798a8baa37e8f522723339cc928"><div class="ttname"><a href="classposix__shm__impl.html#a5faab798a8baa37e8f522723339cc928">posix_shm_impl::get_table</a></div><div class="ttdeci">TableType * get_table()</div><div class="ttdoc">Get mutable pointer to metadata table.</div><div class="ttdef"><b>Definition</b> <a href="posix__shm_8h_source.html#l00260">posix_shm.h:260</a></div></div>
<div class="ttc" id="aclassshm__array_html_a21c2c90de45aec3d3e5686710a82c038"><div class="ttname"><a href="classshm__array.html#a21c2c90de45aec3d3e5686710a82c038">shm_array::name</a></div><div class="ttdeci">std::string_view name() const noexcept</div><div class="ttdoc">Get array name from metadata table.</div><div class="ttdef"><b>Definition</b> <a href="shm__array_8h_source.html#l00353">shm_array.h:353</a></div></div>
<div class="ttc" id="aclassshm__array_html_afcfc180d427db16238d826d6292b5146"><div class="ttname"><a href="classshm__array.html#afcfc180d427db16238d826d6292b5146">shm_array::size</a></div><div class="ttdeci">size_t size() const noexcept</div><div class="ttdoc">Get number of elements.</div><div class="ttdef"><b>Definition</b> <a href="shm__array_8h_source.html#l00221">shm_array.h:221</a></div></div>
<div class="ttc" id="aclassshm__atomic_html_ab892e1c04ee77f259770e3027c6a4c6f"><div class="ttname"><a href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">shm_atomic::load</a></div><div class="ttdeci">T load(std::memory_order order=std::memory_order_seq_cst) const noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__atomic_8h_source.html#l00088">shm_atomic.h:88</a></div></div>
<div class="ttc" id="aclassshm__object__pool_html_a277a01ab36e5a3e34b75189d7cd19c7e"><div class="ttname"><a href="classshm__object__pool.html#a277a01ab36e5a3e34b75189d7cd19c7e">shm_object_pool::get</a></div><div class="ttdeci">T * get(handle_type handle) noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00177">shm_object_pool.h:177</a></div></div>
<div class="ttc" id="aclassshm__object__pool_html_ac4be6afd1ffe22c202ed3960b450eb6b"><div class="ttname"><a href="classshm__object__pool.html#ac4be6afd1ffe22c202ed3960b450eb6b">shm_object_pool::capacity</a></div><div class="ttdeci">size_t capacity() const noexcept</div><div class="ttdoc">Get pool statistics.</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00197">shm_object_pool.h:197</a></div></div>
<div class="ttc" id="aclassshm__object__pool_html_aea9935b1a397973c92cd05afde467e82"><div class="ttname"><a href="classshm__object__pool.html#aea9935b1a397973c92cd05afde467e82">shm_object_pool::num_allocated</a></div><div class="ttdeci">size_t num_allocated() const noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00201">shm_object_pool.h:201</a></div></div>
<div class="ttc" id="aclassshm__queue_html_ac67c4eeba55bf97de3ab7bf90a5422db"><div class="ttname"><a href="classshm__queue.html#ac67c4eeba55bf97de3ab7bf90a5422db">shm_queue::enqueue</a></div><div class="ttdeci">bool enqueue(const T &amp;value) noexcept</div><div class="ttdoc">Enqueue an element (lock-free)</div><div class="ttdef"><b>Definition</b> <a href="shm__queue_8h_source.html#l00115">shm_queue.h:115</a></div></div>
<div class="ttc" id="aclassshm__queue_html_ae572669e48b451812bd4fdae24cb0bd7"><div class="ttname"><a href="classshm__queue.html#ae572669e48b451812bd4fdae24cb0bd7">shm_queue::capacity</a></div><div class="ttdeci">size_t capacity() const noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__queue_8h_source.html#l00184">shm_queue.h:184</a></div></div>
<div class="ttc" id="aclassshm__ring__buffer_html_a5212d32d511179bb618212695b02bb76"><div class="ttname"><a href="classshm__ring__buffer.html#a5212d32d511179bb618212695b02bb76">shm_ring_buffer::capacity</a></div><div class="ttdeci">size_t capacity() const noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00232">shm_ring_buffer.h:232</a></div></div>
<div class="ttc" id="aclassshm__ring__buffer_html_a9cd4ea497d7ad36296aad7a448007f03"><div class="ttname"><a href="classshm__ring__buffer.html#a9cd4ea497d7ad36296aad7a448007f03">shm_ring_buffer::get_last_n</a></div><div class="ttdeci">size_t get_last_n(size_t n, std::span&lt; T &gt; values) const noexcept</div><div class="ttdoc">Get the last N elements (most recent) Useful for getting trailing sensor data.</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00195">shm_ring_buffer.h:195</a></div></div>
<div class="ttc" id="ashm__array_8h_html"><div class="ttname"><a href="shm__array_8h.html">shm_array.h</a></div><div class="ttdoc">Fixed-size shared memory array with STL compatibility.</div></div>
<div class="ttc" id="ashm__atomic_8h_html"><div class="ttname"><a href="shm__atomic_8h.html">shm_atomic.h</a></div></div>
<div class="ttc" id="ashm__object__pool_8h_html"><div class="ttname"><a href="shm__object__pool_8h.html">shm_object_pool.h</a></div></div>
<div class="ttc" id="ashm__queue_8h_html"><div class="ttname"><a href="shm__queue_8h.html">shm_queue.h</a></div></div>
<div class="ttc" id="ashm__ring__buffer_8h_html"><div class="ttname"><a href="shm__ring__buffer_8h.html">shm_ring_buffer.h</a></div></div>
<div class="ttc" id="ashm__table_8h_html_a4092ab716c07d6436f62dac011e22941"><div class="ttname"><a href="shm__table_8h.html#a4092ab716c07d6436f62dac011e22941">shm_table_large</a></div><div class="ttdeci">shm_table_impl&lt; 64, 256 &gt; shm_table_large</div><div class="ttdef"><b>Definition</b> <a href="shm__table_8h_source.html#l00208">shm_table.h:208</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md80"></a>
Memory Layout Visualization</h2>
<p>Here's what the shared memory segment looks like with all these structures:</p>
<div class="fragment"><div class="line">┌────────────────────────────────────────────────┐</div>
<div class="line">│ Shared Memory: &quot;game_server&quot; (500MB)          │</div>
<div class="line">├────────────────────────────────────────────────┤</div>
<div class="line">│ Offset    | Size    | Structure               │</div>
<div class="line">├────────────────────────────────────────────────┤</div>
<div class="line">│ 0x0000    | 4B      | Reference Counter       │</div>
<div class="line">│ 0x0004    | 26KB    | shm_table_large         │</div>
<div class="line">│           |         |   ├─ &quot;players&quot;          │</div>
<div class="line">│           |         |   ├─ &quot;monsters&quot;         │</div>
<div class="line">│           |         |   ├─ &quot;projectiles&quot;      │</div>
<div class="line">│           |         |   ├─ &quot;collision&quot;        │</div>
<div class="line">│           |         |   ├─ &quot;damage_queue&quot;     │</div>
<div class="line">│           |         |   ├─ &quot;spawn_queue&quot;      │</div>
<div class="line">│           |         |   ├─ &quot;network_queue&quot;    │</div>
<div class="line">│           |         |   ├─ &quot;frame_stats&quot;      │</div>
<div class="line">│           |         |   ├─ &quot;tick&quot;             │</div>
<div class="line">│           |         |   ├─ &quot;players_online&quot;   │</div>
<div class="line">│           |         |   ├─ &quot;match_active&quot;     │</div>
<div class="line">│           |         |   └─ &quot;leaderboard&quot;      │</div>
<div class="line">├────────────────────────────────────────────────┤</div>
<div class="line">│ 0x6808    | ~4KB    | Player Pool             │</div>
<div class="line">│ 0x7808    | ~40KB   | Monster Pool            │</div>
<div class="line">│ 0x11408   | ~10KB   | Projectile Pool         │</div>
<div class="line">│ 0x13C08   | 256KB   | Collision Grid          │</div>
<div class="line">│ 0x53C08   | ~16KB   | Damage Queue            │</div>
<div class="line">│ 0x57C08   | ~2KB    | Spawn Queue             │</div>
<div class="line">│ 0x58408   | ~80KB   | Network Queue           │</div>
<div class="line">│ 0x6C408   | ~56KB   | Frame History           │</div>
<div class="line">│ 0x7A008   | 8B      | Tick Counter            │</div>
<div class="line">│ 0x7A010   | 4B      | Player Count            │</div>
<div class="line">│ 0x7A014   | 1B      | Match Active            │</div>
<div class="line">│ 0x7A018   | 400B    | Leaderboard             │</div>
<div class="line">│ ...       | ...     | (Unused space)          │</div>
<div class="line">└────────────────────────────────────────────────┘</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md81"></a>
Key Points About Multiple Structures</h2>
<ol type="1">
<li><b>Single Allocation</b>: One <code>posix_shm</code> object manages the entire segment</li>
<li><b>Automatic Layout</b>: The table system tracks offsets automatically</li>
<li><b>No Fragmentation</b>: Structures are allocated sequentially</li>
<li><b>Discovery by Name</b>: Any process can find any structure</li>
<li><b>Type Safety</b>: Template parameters ensure consistency</li>
<li><b>Independent Lifecycles</b>: Each structure can be used independently</li>
</ol>
<h1><a class="anchor" id="autotoc_md82"></a>
Simple Producer-Consumer</h1>
<h2><a class="anchor" id="autotoc_md83"></a>
Producer Process</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="posix__shm_8h.html">posix_shm.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__queue_8h.html">shm_queue.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>Message {</div>
<div class="line">    uint64_t timestamp;</div>
<div class="line">    <span class="keywordtype">int</span> producer_id;</div>
<div class="line">    <span class="keywordtype">double</span> value;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="basic__usage_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line">    <span class="comment">// Create shared memory and queue</span></div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;producer_consumer&quot;</span>, 1024 * 1024);</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Message&gt;</a> queue(shm, <span class="stringliteral">&quot;messages&quot;</span>, 100);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Produce messages</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000; ++i) {</div>
<div class="line">        Message msg{</div>
<div class="line">            .timestamp = std::chrono::system_clock::now().time_since_epoch().count(),</div>
<div class="line">            .producer_id = 1,</div>
<div class="line">            .value = i * 3.14</div>
<div class="line">        };</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Retry if queue is full</span></div>
<div class="line">        <span class="keywordflow">while</span> (!queue.enqueue(msg)) {</div>
<div class="line">            std::this_thread::sleep_for(std::chrono::microseconds(10));</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Produced message &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(10));</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="abasic__usage_8cpp_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="basic__usage_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition</b> <a href="basic__usage_8cpp_source.html#l00009">basic_usage.cpp:9</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md84"></a>
Consumer Process</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="basic__usage_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line">    <span class="comment">// Open existing shared memory</span></div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;producer_consumer&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Discover queue by name</span></div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Message&gt;</a> queue(shm, <span class="stringliteral">&quot;messages&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Consume messages</span></div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (count &lt; 1000) {</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keyword">auto</span> msg = queue.dequeue()) {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Consumed message from producer &quot;</span> </div>
<div class="line">                      &lt;&lt; msg-&gt;producer_id </div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; with value &quot;</span> &lt;&lt; msg-&gt;value &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            count++;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">// Queue empty, wait a bit</span></div>
<div class="line">            std::this_thread::sleep_for(std::chrono::microseconds(10));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md85"></a>
Particle Simulation System</h1>
<h2><a class="anchor" id="autotoc_md86"></a>
Simulation Core</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="posix__shm_8h.html">posix_shm.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__object__pool_8h.html">shm_object_pool.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__array_8h.html">shm_array.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__atomic_8h.html">shm_atomic.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ParticleSimulation {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm;</div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Particle&gt;</a> particle_pool;</div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;uint32_t&gt;</a> active_particles;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> frame_counter;</div>
<div class="line">    shm_atomic_uint32 active_count;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_struct" href="structParticle.html">Particle</a> {</div>
<div class="line">        <span class="keywordtype">float</span> position[3];</div>
<div class="line">        <span class="keywordtype">float</span> velocity[3];</div>
<div class="line">        <span class="keywordtype">float</span> mass;</div>
<div class="line">        <span class="keywordtype">float</span> lifetime;</div>
<div class="line">        uint32_t type;</div>
<div class="line">        uint32_t flags;</div>
<div class="line">    };</div>
<div class="line">    </div>
<div class="line">    ParticleSimulation(<span class="keyword">const</span> std::string&amp; name, <span class="keywordtype">size_t</span> max_particles)</div>
<div class="line">        : shm(name, calculate_memory_size(max_particles)),</div>
<div class="line">          particle_pool(shm, <span class="stringliteral">&quot;particles&quot;</span>, max_particles),</div>
<div class="line">          active_particles(shm, <span class="stringliteral">&quot;active_list&quot;</span>, max_particles),</div>
<div class="line">          frame_counter(shm, <span class="stringliteral">&quot;frame&quot;</span>, 0),</div>
<div class="line">          active_count(shm, <span class="stringliteral">&quot;active&quot;</span>, 0) {</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">size_t</span> calculate_memory_size(<span class="keywordtype">size_t</span> max_particles) {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<a class="code hl_typedef" href="shm__table_8h.html#aade0116390df12b2def74cdb24366064">shm_table</a>) +                          <span class="comment">// Metadata table</span></div>
<div class="line">               <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structParticle.html">Particle</a>) * max_particles +           <span class="comment">// Particle pool</span></div>
<div class="line">               <span class="keyword">sizeof</span>(uint32_t) * max_particles +           <span class="comment">// Active list</span></div>
<div class="line">               <span class="keyword">sizeof</span>(std::atomic&lt;uint64_t&gt;) +              <span class="comment">// Frame counter</span></div>
<div class="line">               <span class="keyword">sizeof</span>(std::atomic&lt;uint32_t&gt;) +              <span class="comment">// Active count</span></div>
<div class="line">               1024 * 1024;                                  <span class="comment">// Extra buffer</span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    uint32_t spawn_particle(<span class="keyword">const</span> <a class="code hl_struct" href="structParticle.html">Particle</a>&amp; p) {</div>
<div class="line">        <span class="keyword">auto</span> handle = particle_pool.<a class="code hl_function" href="classshm__object__pool.html#a11bc069da2bc46b0d0423379e4b4bece">acquire</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (handle == particle_pool.<a class="code hl_variable" href="classshm__object__pool.html#ae7a249fe0bce87a9f0ccee01df1c4e17">invalid_handle</a>) {</div>
<div class="line">            <span class="keywordflow">return</span> particle_pool.<a class="code hl_variable" href="classshm__object__pool.html#ae7a249fe0bce87a9f0ccee01df1c4e17">invalid_handle</a>;  <span class="comment">// Pool full</span></div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Initialize particle</span></div>
<div class="line">        particle_pool[handle] = p;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Add to active list</span></div>
<div class="line">        uint32_t index = active_count.fetch_add(1);</div>
<div class="line">        active_particles[index] = handle;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> handle;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> update_physics(<span class="keywordtype">float</span> dt) {</div>
<div class="line">        uint32_t count = active_count.load();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Parallel update possible - each particle independent</span></div>
<div class="line"><span class="preprocessor">        #pragma omp parallel for</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; count; ++i) {</div>
<div class="line">            uint32_t handle = active_particles[i];</div>
<div class="line">            <span class="keyword">auto</span>&amp; p = particle_pool[handle];</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Simple physics</span></div>
<div class="line">            p.position[0] += p.velocity[0] * dt;</div>
<div class="line">            p.position[1] += p.velocity[1] * dt;</div>
<div class="line">            p.position[2] += p.velocity[2] * dt;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Gravity</span></div>
<div class="line">            p.velocity[1] -= 9.8f * dt;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Lifetime</span></div>
<div class="line">            p.<a class="code hl_variable" href="structParticle.html#a79e332f17a1b96210a5ae3ce99f68c99">lifetime</a> -= dt;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Remove dead particles</span></div>
<div class="line">        compact_active_list();</div>
<div class="line">        </div>
<div class="line">        frame_counter++;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> compact_active_list() {</div>
<div class="line">        uint32_t read = 0, write = 0;</div>
<div class="line">        uint32_t count = active_count.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (read &lt; count) {</div>
<div class="line">            uint32_t handle = active_particles[read];</div>
<div class="line">            <span class="keyword">auto</span>&amp; p = particle_pool[handle];</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (p.<a class="code hl_variable" href="structParticle.html#a79e332f17a1b96210a5ae3ce99f68c99">lifetime</a> &gt; 0) {</div>
<div class="line">                active_particles[write++] = handle;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                particle_pool.<a class="code hl_function" href="classshm__object__pool.html#ab4b344f5c13d947bed4a96b3cae2086b">release</a>(handle);</div>
<div class="line">            }</div>
<div class="line">            read++;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        active_count.store(write);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassshm__object__pool_html_a11bc069da2bc46b0d0423379e4b4bece"><div class="ttname"><a href="classshm__object__pool.html#a11bc069da2bc46b0d0423379e4b4bece">shm_object_pool::acquire</a></div><div class="ttdeci">handle_type acquire() noexcept</div><div class="ttdoc">Acquire an object from the pool.</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00115">shm_object_pool.h:115</a></div></div>
<div class="ttc" id="aclassshm__object__pool_html_ab4b344f5c13d947bed4a96b3cae2086b"><div class="ttname"><a href="classshm__object__pool.html#ab4b344f5c13d947bed4a96b3cae2086b">shm_object_pool::release</a></div><div class="ttdeci">void release(handle_type handle) noexcept</div><div class="ttdoc">Release an object back to the pool.</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00151">shm_object_pool.h:151</a></div></div>
<div class="ttc" id="aclassshm__object__pool_html_ae7a249fe0bce87a9f0ccee01df1c4e17"><div class="ttname"><a href="classshm__object__pool.html#ae7a249fe0bce87a9f0ccee01df1c4e17">shm_object_pool::invalid_handle</a></div><div class="ttdeci">static constexpr handle_type invalid_handle</div><div class="ttdef"><b>Definition</b> <a href="shm__object__pool_8h_source.html#l00050">shm_object_pool.h:50</a></div></div>
<div class="ttc" id="ashm__table_8h_html_aade0116390df12b2def74cdb24366064"><div class="ttname"><a href="shm__table_8h.html#aade0116390df12b2def74cdb24366064">shm_table</a></div><div class="ttdeci">shm_table_impl&lt; 32, 64 &gt; shm_table</div><div class="ttdef"><b>Definition</b> <a href="shm__table_8h_source.html#l00204">shm_table.h:204</a></div></div>
<div class="ttc" id="astructParticle_html"><div class="ttname"><a href="structParticle.html">Particle</a></div><div class="ttdef"><b>Definition</b> <a href="simulation__patterns_8cpp_source.html#l00013">simulation_patterns.cpp:13</a></div></div>
<div class="ttc" id="astructParticle_html_a79e332f17a1b96210a5ae3ce99f68c99"><div class="ttname"><a href="structParticle.html#a79e332f17a1b96210a5ae3ce99f68c99">Particle::lifetime</a></div><div class="ttdeci">float lifetime</div><div class="ttdef"><b>Definition</b> <a href="simulation__patterns_8cpp_source.html#l00016">simulation_patterns.cpp:16</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md87"></a>
Renderer Process</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="basic__usage_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line">    <span class="comment">// Open existing simulation</span></div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm(<span class="stringliteral">&quot;particle_sim&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Discover data structures</span></div>
<div class="line">    <a class="code hl_class" href="classshm__object__pool.html">shm_object_pool&lt;Particle&gt;</a> particles(shm, <span class="stringliteral">&quot;particles&quot;</span>);</div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;uint32_t&gt;</a> active_list(shm, <span class="stringliteral">&quot;active_list&quot;</span>);</div>
<div class="line">    shm_atomic_uint32 active_count(shm, <span class="stringliteral">&quot;active&quot;</span>);</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> frame(shm, <span class="stringliteral">&quot;frame&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    uint64_t last_frame = 0;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        uint64_t current_frame = frame.load();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Only render if new frame</span></div>
<div class="line">        <span class="keywordflow">if</span> (current_frame != last_frame) {</div>
<div class="line">            uint32_t count = active_count.load();</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Read particle positions</span></div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; count; ++i) {</div>
<div class="line">                uint32_t handle = active_list[i];</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span>&amp; p = particles[handle];</div>
<div class="line">                </div>
<div class="line">                render_particle(p.position, p.<a class="code hl_variable" href="structParticle.html#a0dc463e789de4caca26e88c00d18ee45">type</a>);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            present_frame();</div>
<div class="line">            last_frame = current_frame;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(16));  <span class="comment">// 60 FPS</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="astructParticle_html_a0dc463e789de4caca26e88c00d18ee45"><div class="ttname"><a href="structParticle.html#a0dc463e789de4caca26e88c00d18ee45">Particle::type</a></div><div class="ttdeci">uint32_t type</div><div class="ttdef"><b>Definition</b> <a href="simulation__patterns_8cpp_source.html#l00017">simulation_patterns.cpp:17</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md88"></a>
Sensor Data Pipeline</h1>
<h2><a class="anchor" id="autotoc_md89"></a>
High-Frequency Data Collection</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="shm__ring__buffer_8h.html">shm_ring_buffer.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>SensorCollector {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm;</div>
<div class="line">    <a class="code hl_class" href="classshm__ring__buffer.html">shm_ring_buffer&lt;SensorReading&gt;</a> buffer;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> total_samples;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> dropped_samples;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_struct" href="structSensorReading.html">SensorReading</a> {</div>
<div class="line">        uint64_t timestamp_ns;</div>
<div class="line">        <span class="keywordtype">float</span> values[8];  <span class="comment">// 8 channels</span></div>
<div class="line">        uint16_t status;</div>
<div class="line">        uint16_t sensor_id;</div>
<div class="line">    };</div>
<div class="line">    </div>
<div class="line">    SensorCollector()</div>
<div class="line">        : shm(<span class="stringliteral">&quot;sensor_pipeline&quot;</span>, 100 * 1024 * 1024),  <span class="comment">// 100MB</span></div>
<div class="line">          buffer(shm, <span class="stringliteral">&quot;readings&quot;</span>, 1000000),  <span class="comment">// 1M samples</span></div>
<div class="line">          total_samples(shm, <span class="stringliteral">&quot;total&quot;</span>, 0),</div>
<div class="line">          dropped_samples(shm, <span class="stringliteral">&quot;dropped&quot;</span>, 0) {</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> collect_samples() {</div>
<div class="line">        <a class="code hl_struct" href="structSensorReading.html">SensorReading</a> batch[1000];</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">            <span class="comment">// Read from hardware (simulated)</span></div>
<div class="line">            <span class="keywordtype">size_t</span> collected = read_sensors(batch, 1000);</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Bulk push for efficiency</span></div>
<div class="line">            <span class="keywordtype">size_t</span> pushed = buffer.<a class="code hl_function" href="classshm__ring__buffer.html#a2266dc56a6b0be9eaf2415bbd3be109f">push_bulk</a>({batch, collected});</div>
<div class="line">            </div>
<div class="line">            total_samples.<a class="code hl_function" href="classshm__atomic.html#a0c668df09359f2fbddc3092bf43d0869">fetch_add</a>(pushed);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (pushed &lt; collected) {</div>
<div class="line">                <span class="comment">// Buffer full, using overwrite mode</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = pushed; i &lt; collected; ++i) {</div>
<div class="line">                    buffer.<a class="code hl_function" href="classshm__ring__buffer.html#a5f270620ea62f322bdc7bfc6da848e95">push_overwrite</a>(batch[i]);</div>
<div class="line">                    dropped_samples++;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// 1MHz sampling rate</span></div>
<div class="line">            std::this_thread::sleep_for(std::chrono::microseconds(1000));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassshm__atomic_html_a0c668df09359f2fbddc3092bf43d0869"><div class="ttname"><a href="classshm__atomic.html#a0c668df09359f2fbddc3092bf43d0869">shm_atomic::fetch_add</a></div><div class="ttdeci">T fetch_add(T arg, std::memory_order order=std::memory_order_seq_cst) noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__atomic_8h_source.html#l00111">shm_atomic.h:111</a></div></div>
<div class="ttc" id="aclassshm__ring__buffer_html_a2266dc56a6b0be9eaf2415bbd3be109f"><div class="ttname"><a href="classshm__ring__buffer.html#a2266dc56a6b0be9eaf2415bbd3be109f">shm_ring_buffer::push_bulk</a></div><div class="ttdeci">size_t push_bulk(std::span&lt; const T &gt; values) noexcept</div><div class="ttdoc">Push multiple elements efficiently.</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00115">shm_ring_buffer.h:115</a></div></div>
<div class="ttc" id="aclassshm__ring__buffer_html_a5f270620ea62f322bdc7bfc6da848e95"><div class="ttname"><a href="classshm__ring__buffer.html#a5f270620ea62f322bdc7bfc6da848e95">shm_ring_buffer::push_overwrite</a></div><div class="ttdeci">void push_overwrite(const T &amp;value) noexcept</div><div class="ttdoc">Force overwrite when full (converts to circular overwrite mode) Useful for continuous sensor streams ...</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00273">shm_ring_buffer.h:273</a></div></div>
<div class="ttc" id="astructSensorReading_html"><div class="ttname"><a href="structSensorReading.html">SensorReading</a></div><div class="ttdef"><b>Definition</b> <a href="simulation__patterns_8cpp_source.html#l00020">simulation_patterns.cpp:20</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md90"></a>
Data Processing Pipeline</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>DataProcessor {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm;</div>
<div class="line">    <a class="code hl_class" href="classshm__ring__buffer.html">shm_ring_buffer&lt;SensorReading&gt;</a> input_buffer;</div>
<div class="line">    <a class="code hl_class" href="classshm__ring__buffer.html">shm_ring_buffer&lt;ProcessedData&gt;</a> output_buffer;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> process_pipeline() {</div>
<div class="line">        <a class="code hl_struct" href="structSensorReading.html">SensorReading</a> raw_batch[100];</div>
<div class="line">        ProcessedData processed_batch[100];</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">            <span class="comment">// Bulk read from input</span></div>
<div class="line">            <span class="keywordtype">size_t</span> count = input_buffer.<a class="code hl_function" href="classshm__ring__buffer.html#a550f03faa1a03ea762aa0432017cb1ff">pop_bulk</a>(raw_batch);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (count &gt; 0) {</div>
<div class="line">                <span class="comment">// Process data (FFT, filtering, etc.)</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; count; ++i) {</div>
<div class="line">                    processed_batch[i] = process_reading(raw_batch[i]);</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// Push to next stage</span></div>
<div class="line">                output_buffer.<a class="code hl_function" href="classshm__ring__buffer.html#a2266dc56a6b0be9eaf2415bbd3be109f">push_bulk</a>({processed_batch, count});</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="comment">// No data, brief wait</span></div>
<div class="line">                std::this_thread::sleep_for(std::chrono::microseconds(100));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    ProcessedData process_reading(<span class="keyword">const</span> <a class="code hl_struct" href="structSensorReading.html">SensorReading</a>&amp; raw) {</div>
<div class="line">        ProcessedData result;</div>
<div class="line">        <span class="comment">// Apply filters, transforms, etc.</span></div>
<div class="line">        <span class="keywordflow">return</span> result;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassshm__ring__buffer_html_a550f03faa1a03ea762aa0432017cb1ff"><div class="ttname"><a href="classshm__ring__buffer.html#a550f03faa1a03ea762aa0432017cb1ff">shm_ring_buffer::pop_bulk</a></div><div class="ttdeci">size_t pop_bulk(std::span&lt; T &gt; values) noexcept</div><div class="ttdoc">Pop multiple elements efficiently.</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00152">shm_ring_buffer.h:152</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md91"></a>
Multi-Process Coordination</h1>
<h2><a class="anchor" id="autotoc_md92"></a>
Master-Worker Pattern</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>TaskScheduler {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm;</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Task&gt;</a> task_queue;</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Result&gt;</a> result_queue;</div>
<div class="line">    shm_atomic_uint32 workers_ready;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_bool</a> shutdown;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">struct </span>Task {</div>
<div class="line">        uint64_t task_id;</div>
<div class="line">        uint32_t type;</div>
<div class="line">        <span class="keywordtype">char</span> parameters[256];</div>
<div class="line">    };</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">struct </span>Result {</div>
<div class="line">        uint64_t task_id;</div>
<div class="line">        uint32_t worker_id;</div>
<div class="line">        <span class="keywordtype">bool</span> success;</div>
<div class="line">        <span class="keywordtype">char</span> output[1024];</div>
<div class="line">    };</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Master process</span></div>
<div class="line">    <span class="keywordtype">void</span> run_master() {</div>
<div class="line">        <span class="comment">// Wait for workers</span></div>
<div class="line">        <span class="keywordflow">while</span> (workers_ready.load() &lt; 4) {</div>
<div class="line">            std::this_thread::sleep_for(std::chrono::milliseconds(100));</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Distribute tasks</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint64_t i = 0; i &lt; 1000; ++i) {</div>
<div class="line">            Task t{.task_id = i, .type = i % 4};</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">while</span> (!task_queue.<a class="code hl_function" href="classshm__queue.html#ac67c4eeba55bf97de3ab7bf90a5422db">enqueue</a>(t)) {</div>
<div class="line">                <span class="comment">// Process results while waiting</span></div>
<div class="line">                process_results();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Collect all results</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000; ++i) {</div>
<div class="line">            process_results();</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        shutdown.<a class="code hl_function" href="classshm__atomic.html#a8ebc57da8b87b57f8ea095a4bc2a9289">store</a>(<span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Worker process</span></div>
<div class="line">    <span class="keywordtype">void</span> run_worker(uint32_t worker_id) {</div>
<div class="line">        workers_ready++;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (!shutdown.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>()) {</div>
<div class="line">            <span class="keywordflow">if</span> (<span class="keyword">auto</span> task = task_queue.<a class="code hl_function" href="classshm__queue.html#af4fbaa56d695376596922f502a52852e">dequeue</a>()) {</div>
<div class="line">                Result r{</div>
<div class="line">                    .task_id = task-&gt;task_id,</div>
<div class="line">                    .worker_id = worker_id,</div>
<div class="line">                    .success = <span class="keyword">true</span></div>
<div class="line">                };</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// Process task</span></div>
<div class="line">                execute_task(*task, r);</div>
<div class="line">                </div>
<div class="line">                <span class="comment">// Submit result</span></div>
<div class="line">                <span class="keywordflow">while</span> (!result_queue.<a class="code hl_function" href="classshm__queue.html#ac67c4eeba55bf97de3ab7bf90a5422db">enqueue</a>(r)) {</div>
<div class="line">                    <span class="keywordflow">if</span> (shutdown.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>()) <span class="keywordflow">break</span>;</div>
<div class="line">                    std::this_thread::yield();</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                std::this_thread::sleep_for(std::chrono::microseconds(10));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassshm__atomic_html_a8ebc57da8b87b57f8ea095a4bc2a9289"><div class="ttname"><a href="classshm__atomic.html#a8ebc57da8b87b57f8ea095a4bc2a9289">shm_atomic::store</a></div><div class="ttdeci">void store(T value, std::memory_order order=std::memory_order_seq_cst) noexcept</div><div class="ttdef"><b>Definition</b> <a href="shm__atomic_8h_source.html#l00084">shm_atomic.h:84</a></div></div>
<div class="ttc" id="aclassshm__queue_html_af4fbaa56d695376596922f502a52852e"><div class="ttname"><a href="classshm__queue.html#af4fbaa56d695376596922f502a52852e">shm_queue::dequeue</a></div><div class="ttdeci">std::optional&lt; T &gt; dequeue() noexcept</div><div class="ttdoc">Dequeue an element (lock-free)</div><div class="ttdef"><b>Definition</b> <a href="shm__queue_8h_source.html#l00133">shm_queue.h:133</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md93"></a>
Error Handling &amp; Recovery</h1>
<h2><a class="anchor" id="autotoc_md94"></a>
Robust Initialization</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>RobustSystem {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> std::unique_ptr&lt;RobustSystem&gt; create(<span class="keyword">const</span> std::string&amp; name) {</div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            <span class="comment">// Try to create new</span></div>
<div class="line">            <span class="keywordflow">return</span> std::make_unique&lt;RobustSystem&gt;(name, <span class="keyword">true</span>);</div>
<div class="line">        } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">            <span class="comment">// Try to attach to existing</span></div>
<div class="line">            <span class="keywordflow">try</span> {</div>
<div class="line">                <span class="keywordflow">return</span> std::make_unique&lt;RobustSystem&gt;(name, <span class="keyword">false</span>);</div>
<div class="line">            } <span class="keywordflow">catch</span> (...) {</div>
<div class="line">                <span class="comment">// Clean up and retry</span></div>
<div class="line">                cleanup_shared_memory(name);</div>
<div class="line">                <span class="keywordflow">return</span> std::make_unique&lt;RobustSystem&gt;(name, <span class="keyword">true</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> cleanup_shared_memory(<span class="keyword">const</span> std::string&amp; name) {</div>
<div class="line">        <span class="comment">// Force cleanup of stale shared memory</span></div>
<div class="line">        shm_unlink(name.c_str());</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md95"></a>
Crash Recovery</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>CrashResilientQueue {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <a class="code hl_class" href="classshm__queue.html">shm_queue&lt;Message&gt;</a> queue;</div>
<div class="line">    <a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> last_processed_id;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> process_with_recovery() {</div>
<div class="line">        uint64_t last_id = last_processed_id.<a class="code hl_function" href="classshm__atomic.html#ab892e1c04ee77f259770e3027c6a4c6f">load</a>();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">            <span class="keywordflow">if</span> (<span class="keyword">auto</span> msg = queue.<a class="code hl_function" href="classshm__queue.html#af4fbaa56d695376596922f502a52852e">dequeue</a>()) {</div>
<div class="line">                <span class="keywordflow">if</span> (msg-&gt;id &lt;= last_id) {</div>
<div class="line">                    <span class="comment">// Already processed, skip</span></div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">try</span> {</div>
<div class="line">                    process_message(*msg);</div>
<div class="line">                    last_processed_id.<a class="code hl_function" href="classshm__atomic.html#a8ebc57da8b87b57f8ea095a4bc2a9289">store</a>(msg-&gt;id);</div>
<div class="line">                } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
<div class="line">                    <span class="comment">// Log error but continue</span></div>
<div class="line">                    log_error(e.what());</div>
<div class="line">                    <span class="comment">// Message lost but system continues</span></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md96"></a>
Monitoring &amp; Diagnostics</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>SystemMonitor {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">struct </span>Stats {</div>
<div class="line">        std::atomic&lt;uint64_t&gt; messages_processed{0};</div>
<div class="line">        std::atomic&lt;uint64_t&gt; errors_count{0};</div>
<div class="line">        std::atomic&lt;uint64_t&gt; queue_full_count{0};</div>
<div class="line">        std::atomic&lt;double&gt; avg_latency_us{0};</div>
<div class="line">        std::atomic&lt;uint64_t&gt; last_heartbeat{0};</div>
<div class="line">    };</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_class" href="classposix__shm__impl.html">posix_shm</a> shm;</div>
<div class="line">    <a class="code hl_class" href="classshm__array.html">shm_array&lt;Stats&gt;</a> process_stats;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> monitor_system() {</div>
<div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">            <span class="keyword">auto</span> now = std::chrono::system_clock::now().time_since_epoch().count();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; process_stats.<a class="code hl_function" href="classshm__array.html#afcfc180d427db16238d826d6292b5146">size</a>(); ++i) {</div>
<div class="line">                <span class="keyword">auto</span>&amp; stats = process_stats[i];</div>
<div class="line">                uint64_t last_heartbeat = stats.last_heartbeat.load();</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">if</span> (now - last_heartbeat &gt; 5000000000) {  <span class="comment">// 5 seconds</span></div>
<div class="line">                    std::cerr &lt;&lt; <span class="stringliteral">&quot;Process &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; appears hung!\n&quot;</span>;</div>
<div class="line">                    alert_operator(i);</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;Process &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;: &quot;</span></div>
<div class="line">                          &lt;&lt; stats.messages_processed.load() &lt;&lt; <span class="stringliteral">&quot; messages, &quot;</span></div>
<div class="line">                          &lt;&lt; stats.errors_count.load() &lt;&lt; <span class="stringliteral">&quot; errors, &quot;</span></div>
<div class="line">                          &lt;&lt; stats.avg_latency_us.load() &lt;&lt; <span class="stringliteral">&quot; µs latency\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            std::this_thread::sleep_for(std::chrono::seconds(1));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md97"></a>
Best Practices</h1>
<h2><a class="anchor" id="autotoc_md98"></a>
1. &lt;strong&gt;Always Name Your Structures&lt;/strong&gt;</h2>
<div class="fragment"><div class="line"><span class="comment">// Good - discoverable</span></div>
<div class="line"><a class="code hl_class" href="classshm__array.html">shm_array&lt;float&gt;</a> data(shm, <span class="stringliteral">&quot;sensor_readings&quot;</span>, 1000);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bad - anonymous, not discoverable</span></div>
<div class="line"><span class="keywordtype">float</span>* data = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span>*<span class="keyword">&gt;</span>(shm.<a class="code hl_function" href="classposix__shm__impl.html#afe7758e3e261c986c37f3616afeef681">get_base_addr</a>());</div>
<div class="ttc" id="aclassposix__shm__impl_html_afe7758e3e261c986c37f3616afeef681"><div class="ttname"><a href="classposix__shm__impl.html#afe7758e3e261c986c37f3616afeef681">posix_shm_impl::get_base_addr</a></div><div class="ttdeci">void * get_base_addr() const</div><div class="ttdoc">Get base address for user data (after header)</div><div class="ttdef"><b>Definition</b> <a href="posix__shm_8h_source.html#l00222">posix_shm.h:222</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md99"></a>
2. &lt;strong&gt;Handle Full Conditions Gracefully&lt;/strong&gt;</h2>
<div class="fragment"><div class="line"><span class="comment">// Good - retry with backoff</span></div>
<div class="line"><span class="keywordflow">while</span> (!queue.<a class="code hl_function" href="classshm__queue.html#ac67c4eeba55bf97de3ab7bf90a5422db">enqueue</a>(msg)) {</div>
<div class="line">    <span class="keywordflow">if</span> (++retries &gt; max_retries) {</div>
<div class="line">        handle_overflow();</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    std::this_thread::sleep_for(backoff);</div>
<div class="line">    backoff *= 2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bad - silent data loss</span></div>
<div class="line">queue.<a class="code hl_function" href="classshm__queue.html#ac67c4eeba55bf97de3ab7bf90a5422db">enqueue</a>(msg);  <span class="comment">// Ignoring return value</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md100"></a>
3. &lt;strong&gt;Use Bulk Operations for Efficiency&lt;/strong&gt;</h2>
<div class="fragment"><div class="line"><span class="comment">// Good - amortize overhead</span></div>
<div class="line">Reading batch[100];</div>
<div class="line"><span class="keywordtype">size_t</span> count = buffer.<a class="code hl_function" href="classshm__ring__buffer.html#a550f03faa1a03ea762aa0432017cb1ff">pop_bulk</a>(batch);</div>
<div class="line">process_batch(batch, count);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bad - one at a time</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 100; ++i) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> val = buffer.<a class="code hl_function" href="classshm__ring__buffer.html#a7fb84e8c159aa0af7831357c6b76530b">pop</a>()) {</div>
<div class="line">        process_single(*val);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassshm__ring__buffer_html_a7fb84e8c159aa0af7831357c6b76530b"><div class="ttname"><a href="classshm__ring__buffer.html#a7fb84e8c159aa0af7831357c6b76530b">shm_ring_buffer::pop</a></div><div class="ttdeci">std::optional&lt; T &gt; pop() noexcept</div><div class="ttdoc">Pop a single element.</div><div class="ttdef"><b>Definition</b> <a href="shm__ring__buffer_8h_source.html#l00134">shm_ring_buffer.h:134</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md101"></a>
4. &lt;strong&gt;Monitor System Health&lt;/strong&gt;</h2>
<div class="fragment"><div class="line"><span class="comment">// Good - observable system</span></div>
<div class="line"><a class="code hl_class" href="classshm__atomic.html">shm_atomic_uint64</a> heartbeat(shm, <span class="stringliteral">&quot;heartbeat&quot;</span>);</div>
<div class="line"><span class="keywordflow">while</span> (running) {</div>
<div class="line">    do_work();</div>
<div class="line">    heartbeat.store(now());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bad - black box</span></div>
<div class="line"><span class="keywordflow">while</span> (running) {</div>
<div class="line">    do_work();  <span class="comment">// No visibility</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md102"></a>
5. &lt;strong&gt;Plan for Growth&lt;/strong&gt;</h2>
<div class="fragment"><div class="line"><span class="comment">// Good - configurable</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">size_t</span> MAX_PARTICLES = </div>
<div class="line">    std::getenv(<span class="stringliteral">&quot;MAX_PARTICLES&quot;</span>) ? </div>
<div class="line">    std::atoi(std::getenv(<span class="stringliteral">&quot;MAX_PARTICLES&quot;</span>)) : 10000;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bad - hardcoded limits</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">size_t</span> MAX_PARTICLES = 1000;  <span class="comment">// Will need recompile</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
